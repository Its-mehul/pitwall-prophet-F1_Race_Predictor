<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitwall Prophet - F1 Position Predictor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --f1-red: #E10600;
            --f1-orange: #FF4500;
            --bg-dark: #2a2438;
            --bg-darker: #1a1625;
            --card-bg: rgba(60, 50, 70, 0.4);
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Titillium Web', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0d0509 0%, #1a0a0f 40%, #260d15 60%, #1a0a0f 100%);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Landing Page */
        .landing-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, rgba(225, 6, 0, 0.15) 0%, transparent 70%);
            position: relative;
        }
        
        .f1-logo {
            font-size: 12em;
            font-weight: 900;
            color: var(--f1-orange);
            text-shadow: 0 0 60px rgba(255, 69, 0, 0.6);
            margin-bottom: 40px;
            letter-spacing: -15px;
            font-family: 'Titillium Web', sans-serif;
        }
        
        .landing-title {
            font-size: 4em;
            font-weight: 900;
            background: linear-gradient(90deg, #ffffff 0%, #ffffff 40%, var(--f1-orange) 60%, var(--f1-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .landing-subtitle {
            font-size: 1.3em;
            color: var(--text-white);
            margin-bottom: 80px;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 600;
        }
        
        .landing-controls {
            display: flex;
            gap: 30px;
        }
        
        button {
            background: var(--f1-red);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(225, 6, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Titillium Web', sans-serif;
        }
        
        button:hover {
            background: #ff0800;
            box-shadow: 0 12px 35px rgba(225, 6, 0, 0.6);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Grid Page */
        .grid-page {
            min-height: 100vh;
            padding: 60px 40px;
            background: linear-gradient(135deg, #0d0509 0%, #1a0a0f 40%, #260d15 60%, #1a0a0f 100%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .grid-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .grid-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .flag-icon {
            font-size: 3em;
            filter: drop-shadow(0 0 10px rgba(225, 6, 0, 0.5));
        }
        
        .grid-title {
            font-size: 3.5em;
            font-weight: 900;
            color: var(--f1-red);
            text-shadow: 0 0 20px rgba(225, 6, 0, 0.5);
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        
        .race-name {
            font-size: 1.3em;
            color: var(--text-white);
            margin-bottom: 15px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 2px;
        }
        
        .race-underline {
            width: 600px;
            height: 3px;
            background: var(--f1-red);
            margin: 0 auto 15px;
        }
        
        .race-btn-top {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .race-btn-top button {
            background: transparent;
            font-size: 1.8em;
            padding: 25px 70px;
            box-shadow: none;
            color: var(--f1-red);
            text-shadow: 0 0 20px rgba(225, 6, 0, 0.8);
        }
        
        .race-btn-top button:hover {
            box-shadow: none;
            text-shadow: 0 0 30px rgba(225, 6, 0, 1);
            transform: scale(1.05);
        }
        
        .start-lights {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .light-set {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .light {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .light.red {
            background: var(--f1-red);
            border-color: var(--f1-red);
            box-shadow: 
                0 0 20px var(--f1-red),
                0 0 40px var(--f1-red),
                inset 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .light.green {
            background: #00ff00;
            border-color: #00ff00;
            box-shadow: 
                0 0 20px #00ff00,
                0 0 40px #00ff00,
                inset 0 0 10px rgba(255, 255, 255, 0.5);
            animation: greenPulse 0.5s ease-out;
        }
        
        @keyframes greenPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .grid-container {
            background: var(--card-bg);
            border: 2px solid rgba(225, 6, 0, 0.3);
            border-radius: 20px;
            padding: 50px 40px;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .driver-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .driver-card {
            background: rgba(40, 35, 50, 0.6);
            border: 2px solid rgba(100, 80, 120, 0.4);
            border-radius: 12px;
            padding: 15px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .driver-card:hover {
            border-color: var(--f1-red);
            box-shadow: 0 0 20px rgba(225, 6, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .position-badge {
            background: var(--f1-red);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.3em;
            flex-shrink: 0;
        }
        
        .team-logo-box {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            flex-shrink: 0;
        }
        
        .team-logo {
            width: 100%;
            height: 100%;
            object-fit: scale-down;
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 4px;
        }
        
        .team-name {
            font-size: 0.9em;
            color: var(--text-gray);
            font-weight: 400;
        }
        
        .grid-actions {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 50px;
        }
        
        /* Results Page */
        .results-page {
            min-height: 100vh;
            padding: 60px 40px;
            background: linear-gradient(135deg, #0d0509 0%, #1a0a0f 40%, #260d15 60%, #1a0a0f 100%);
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .results-title {
            font-size: 3.5em;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, var(--f1-red) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        .results-subtitle {
            font-size: 1.3em;
            color: var(--text-gray);
            font-weight: 300;
        }
        
        .results-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 40px;
        }
        
        .result-row {
            display: grid;
            grid-template-columns: 80px 80px 1fr 1fr;
            gap: 25px;
            align-items: center;
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 12px;
            border: 2px solid rgba(100, 80, 120, 0.4);
            transition: all 0.3s ease;
        }
        
        .result-row.with-actual {
            grid-template-columns: 80px 80px 1fr 1fr 100px;
        }
        
        .result-row:hover {
            border-color: var(--f1-red);
            transform: translateX(5px);
        }
        
        .result-position {
            background: var(--f1-red);
            color: white;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.8em;
        }
        
        .result-position.pos-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
        }
        
        .result-position.pos-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
            color: #000;
        }
        
        .result-position.pos-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #B87333 100%);
            color: #000;
        }

        .result-position.dnf {
            background: #85888b; /* grey */
            color: #fff;
            font-size: 1em;
            letter-spacing: 0.5px;
        }
        
        .result-logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
        }
        
        .result-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .result-driver {
            font-weight: 700;
            font-size: 1.4em;
            color: var(--text-white);
        }
        
        .result-team {
            color: var(--text-gray);
            font-size: 1.1em;
        }
        
        .position-label {
            text-align: center;
            font-size: 1.2em;
            font-weight: 700;
            text-transform: uppercase;
            color: #000;
        }
        
        .message-area {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <div class="f1-logo">F1</div>
        <h1 class="landing-title">PITWALL PROPHET</h1>
        <p class="landing-subtitle">Multi-Layer Neural Network-Powered Race Position Predictions</p>
        
        <div class="landing-controls">
            <button onclick="loadSampleData()">Load Sample Race</button>
            <button onclick="document.getElementById('csvFile').click()">Upload CSV</button>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
        </div>
    </div>
    
    <!-- Grid Page -->
    <div id="gridPage" class="grid-page hidden">
        <div class="container">
            <div class="grid-header">
                <div class="grid-title-wrapper">
                    <div class="flag-icon">üèÅ</div>
                    <h1 class="grid-title">STARTING GRID</h1>
                </div>
                <p class="race-name" id="raceName"></p>
                <div class="race-underline"></div>
            </div>
            
            <div class="race-btn-top">
                <button onclick="predictPositions()">üèÅ RACE</button>
            </div>
            
            <div class="start-lights">
                <div class="light-set" data-column="0">
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light red"></div>
                    <div class="light red"></div>
                </div>
                <div class="light-set" data-column="1">
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light red"></div>
                    <div class="light red"></div>
                </div>
                <div class="light-set" data-column="2">
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light red"></div>
                    <div class="light red"></div>
                </div>
                <div class="light-set" data-column="3">
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light red"></div>
                    <div class="light red"></div>
                </div>
                <div class="light-set" data-column="4">
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light"></div>
                    <div class="light red"></div>
                    <div class="light red"></div>
                </div>
            </div>
            
            <div class="grid-container">
                <div id="topHalf" class="driver-grid"></div>
                <div id="bottomHalf" class="driver-grid"></div>
            </div>
            
            <div class="grid-actions">
                <button onclick="backToLanding()">‚Üê Back to Home</button>
            </div>
        </div>
    </div>
    
    <!-- Results Page -->
    <div id="resultsPage" class="results-page hidden">
        <div class="container">
            <div class="results-header">
                <h1 class="results-title">üèÜ Race Predictions</h1>
                <p class="results-subtitle">Multi-Layer Neural Network Finishing Order</p>
            </div>
            
            <div id="results" class="results-grid"></div>
            
            <div class="grid-actions">
                <button onclick="backToLanding()">‚Üê New Prediction</button>
            </div>
        </div>
    </div>
    
    <div id="messageArea" class="message-area"></div>
    
    <script>
        const API_URL = '/api';
        let currentDrivers = [];
        let currentRaceData = null;
        let hasActualPositions = false;  // Track if we have ground truth data
        
        // Team logo mapping
        function getTeamLogoPath(teamName) {
            if (!teamName) return '';
            
            // Remove engine manufacturers and sponsors ONLY when they appear as suffixes
            // Be careful not to remove "Mercedes" or "Ferrari" when they're the actual team name
            let cleanName = teamName
                .replace(/\s+Honda(\s+RBPT)?$/gi, '')  // Remove Honda at end
                .replace(/\s+RBPT$/gi, '')  // Remove RBPT at end
                .replace(/\s+TAG Heuer$/gi, '')  // Remove TAG Heuer at end
                .replace(/\s+Renault$/gi, '')  // Remove Renault at end
                .replace(/\s+Aramco/gi, '')  // Remove Aramco anywhere
                .replace(/\s+BWT/gi, '')  // Remove BWT anywhere
                .replace(/\s+Petronas/gi, '')  // Remove Petronas anywhere
                .replace(/\s+AMG/gi, '')  // Remove AMG anywhere
                .replace(/Mercedes-AMG Petronas/gi, 'Mercedes')
                .replace(/Racing Bulls/gi, 'RB')
                .replace(/Kick Sauber/gi, 'Sauber')
                .replace(/VCARB/gi, 'RB')
                // Strip " Mercedes" or " Ferrari" ONLY when preceded by another team name
                .replace(/(Aston Martin|McLaren|Williams|Haas|Sauber|Kick Sauber)\s+(Mercedes|Ferrari)/gi, '$1')
                .replace(/\s+/g, ' ')  // Normalize whitespace
                .trim();
            
            console.log(`Team mapping: "${teamName}" -> "${cleanName}"`);
            
            const logoMap = {
                'Mercedes': 'mercedes.png',
                'Ferrari': 'ferrari.png',
                'Red Bull Racing': 'redbull_racing.png',
                'Red Bull': 'redbull_racing.png',
                'McLaren': 'mclaren.jpg',
                'Aston Martin': 'aston_martin.png',
                'Alpine': 'alpine.png',
                'Williams': 'williams.jpeg',
                'AlphaTauri': 'racing_bulls.jpg',
                'Alfa Romeo': 'kick_sauber.png',
                'Haas F1 Team': 'haas_f1.png',
                'Haas': 'haas_f1.png',
                'Sauber': 'kick_sauber.png',
                'RB': 'racing_bulls.jpg'
            };
            
            const logoFile = logoMap[cleanName];
            console.log(`Logo file for "${cleanName}": ${logoFile}`);
            return logoFile ? `assets/teams/${logoFile}` : '';
        }
        
        // Initialize
        async function init() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                if (!data.model_loaded) {
                    showMessage('Warning: Model not loaded', 'error');
                }
            } catch (error) {
                showMessage('Error connecting to API', 'error');
            }
        }
        
        // Load sample race
        async function loadSampleData() {
            try {
                showMessage('Loading sample race...', 'success');
                const response = await fetch(`${API_URL}/sample_data`);
                const data = await response.json();
                
                if (data.error) {
                    showMessage(data.error, 'error');
                    return;
                }
                
                currentRaceData = data;
                currentDrivers = data.drivers;
                hasActualPositions = true;  // Sample data has actual positions
                
                // Display race info - construct full race name from race_info
                if (data.race_info) {
                    const raceName = `${data.race_info.year} - ROUND ${data.race_info.round}: ${data.race_info.name}`;
                    document.getElementById('raceName').textContent = raceName.toUpperCase();
                } else {
                    document.getElementById('raceName').textContent = 'SAMPLE RACE';
                }
                
                renderDriverGrid();
                showGridPage();
                showMessage(`Loaded ${currentDrivers.length} drivers`, 'success');
            } catch (error) {
                showMessage('Error loading data: ' + error.message, 'error');
            }
        }
        
        // Render driver grid
        function renderDriverGrid() {
            const topHalf = document.getElementById('topHalf');
            const bottomHalf = document.getElementById('bottomHalf');
            topHalf.innerHTML = '';
            bottomHalf.innerHTML = '';
            
            const midpoint = Math.ceil(currentDrivers.length / 2);
            
            currentDrivers.forEach((driver, index) => {
                const card = document.createElement('div');
                card.className = 'driver-card';
                
                const gridPos = driver.grid_position || (index + 1);
                const logoPath = getTeamLogoPath(driver.team_name);
                
                console.log(`Driver: ${driver.driver_name}, Team: ${driver.team_name}, Logo Path: ${logoPath}`);
                
                card.innerHTML = `
                    <div class="position-badge">P${Math.round(gridPos)}</div>
                    <div class="team-logo-box">
                        ${logoPath ? `<img src="${logoPath}" alt="${driver.team_name}" class="team-logo" onerror="console.error('Failed to load: ${logoPath}');">` : '<div style="color: #666;">No Logo</div>'}
                    </div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.driver_name}</div>
                        <div class="team-name">${driver.team_name}</div>
                    </div>
                `;
                
                if (index < midpoint) {
                    topHalf.appendChild(card);
                } else {
                    bottomHalf.appendChild(card);
                }
            });
        }
        
        // Animate start lights turning green column by column
        function animateStartLights() {
            const lightSets = document.querySelectorAll('.light-set');
            let delay = 0;
            
            lightSets.forEach((set, index) => {
                setTimeout(() => {
                    // Only turn the bottom 2 lights (indices 3 and 4) green
                    const lights = set.querySelectorAll('.light');
                    if (lights[3]) {
                        lights[3].classList.remove('red');
                        lights[3].classList.add('green');
                    }
                    if (lights[4]) {
                        lights[4].classList.remove('red');
                        lights[4].classList.add('green');
                    }
                }, delay);
                delay += 1000; // 1 second between each column for authentic F1 race start
            });
        }
        
        // Reset lights to red
        function resetStartLights() {
            const lightSets = document.querySelectorAll('.light-set');
            lightSets.forEach(set => {
                const lights = set.querySelectorAll('.light');
                // Reset only bottom 2 lights to red
                if (lights[3]) {
                    lights[3].classList.remove('green');
                    lights[3].classList.add('red');
                }
                if (lights[4]) {
                    lights[4].classList.remove('green');
                    lights[4].classList.add('red');
                }
            });
        }
        
        // Predict positions
        async function predictPositions() {
            console.log('predictPositions() called');
            console.log('currentDrivers:', currentDrivers);
            
            if (!currentDrivers || currentDrivers.length === 0) {
                console.error('No data loaded');
                showMessage('No data loaded', 'error');
                return;
            }
            
            console.log('Starting prediction with', currentDrivers.length, 'drivers');
            
            // Animate lights during prediction (1.5 seconds total)
            animateStartLights();
            
            try {
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        drivers: currentDrivers,
                        race_data: currentRaceData
                    })
                });
                
                const data = await response.json();
                
                console.log('Predict response received:', data);
                
                if (data.error) {
                    console.error('Prediction error:', data.error);
                    showMessage(data.error, 'error');
                    return;
                }
                
                if (!data.predictions || data.predictions.length === 0) {
                    console.error('No predictions in response');
                    showMessage('No predictions received', 'error');
                    return;
                }
                
                console.log('Waiting for 5 second light animation...');
                // Wait for light animation to complete (5 seconds for F1 race start sequence)
                setTimeout(() => {
                    console.log('Animation complete, showing results');
                    displayResults(data.predictions);
                    showResultsPage();
                }, 5000);
                
            } catch (error) {
                showMessage('Prediction error: ' + error.message, 'error');
            }
        }
        
        // Display results
        function displayResults(predictions) {
            const resultsGrid = document.getElementById('results');
            resultsGrid.innerHTML = '';
            
            console.log('Displaying results, first prediction:', predictions[0]);
            
            // Treat any predicted position > 20 as DNF (model may use 21 as DNF sentinel)
            const normal = [];
            const dnfs = [];
            predictions.forEach(p => {
                const pos = p.predicted_position;
                // Consider undefined/null/0 or >20 as DNF
                const isDnf = pos === undefined || pos === null || pos === 0 || (Number(pos) > 20);
                if (isDnf) dnfs.push(p);
                else normal.push(p);
            });

            // Sort non-DNF by predicted position ascending
            normal.sort((a, b) => a.predicted_position - b.predicted_position);

            // Append DNFs after normal predictions
            let ordered = normal.concat(dnfs);

            // If model produced more than 20 entries, trim to 20 to avoid showing an extra index
            if (ordered.length > 20) ordered = ordered.slice(0, 20);

            ordered.forEach((result, index) => {
                const row = document.createElement('div');
                row.className = hasActualPositions ? 'result-row with-actual' : 'result-row';

                const position = result.predicted_position;
                let posClass = '';
                if (position === 1) posClass = 'pos-1';
                else if (position === 2) posClass = 'pos-2';
                else if (position === 3) posClass = 'pos-3';

                const logoPath = getTeamLogoPath(result.team_name);

                // Calculate prediction accuracy
                console.log('Result object:', result);
                const actualPos = result.actual_position;
                const predictedPos = result.predicted_position;

                console.log(`Driver ${result.driver_name}: actualPos=${actualPos} (type: ${typeof actualPos}), predictedPos=${predictedPos}`);

                let diff, diffLabel;

                // Check if actual_position exists and is valid
                if (actualPos === undefined || actualPos === null || actualPos === 0) {
                    // DNF or missing data - show as DNF
                    diff = 0;
                    diffLabel = 'DNF';
                } else {
                    // Valid position - calculate difference
                    diff = predictedPos - actualPos;  // Positive = predicted higher, negative = predicted lower

                    // Format difference label
                    if (diff === 0) {
                        diffLabel = '‚úì EXACT';
                    } else if (diff > 0) {
                        diffLabel = `+${diff}`;
                    } else {
                        diffLabel = `${diff}`;
                    }
                }

                // Choose badge: grey DNF badge when predicted_position === 0, else show number with pos classes
                const isPredDnf = predictedPos === 0 || predictedPos === null || predictedPos === undefined || Number(predictedPos) > 20;
                const badgeHtml = isPredDnf
                    ? `<div class="result-position dnf">DNF</div>`
                    : `<div class="result-position ${posClass}">${position}</div>`;

                row.innerHTML = `
                    ${badgeHtml}
                    <div class="result-logo">
                        ${logoPath ? `<img src="${logoPath}" alt="${result.team_name}">` : ''}
                    </div>
                    <div class="result-driver">${result.driver_name}</div>
                    <div class="result-team">${result.team_name}</div>
                    ${hasActualPositions ? `<div class="position-label" title="Predicted: P${predictedPos}, Actual: P${actualPos}, Difference: ${diff}">
                        ${diffLabel}
                    </div>` : ''}
                `;

                resultsGrid.appendChild(row);
            });
        }
        
        // Navigation
        function showGridPage() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('gridPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
        }
        
        function showResultsPage() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('gridPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
        }
        
        function backToLanding() {
            document.getElementById('landingPage').classList.remove('hidden');
            document.getElementById('gridPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            resetStartLights();
            currentDrivers = [];
            currentRaceData = null;
        }
        
        // Messages
        function showMessage(text, type = 'success') {
            // Log to console since visual messages are disabled
            console.log(`[${type.toUpperCase()}] ${text}`);
        }
        
        // CSV upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            console.log('File selected:', file);
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                console.log('Uploading CSV to:', `${API_URL}/upload_csv`);
                showMessage('Uploading CSV...', 'success');
                const response = await fetch(`${API_URL}/upload_csv`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.error) {
                    console.error('Upload error:', data.error);
                    showMessage(data.error, 'error');
                    return;
                }
                
                // Upload CSV returns predictions directly, not drivers array
                // Convert predictions to drivers format for grid display
                currentDrivers = data.predictions.map((pred, index) => ({
                    driver_name: pred.driver_name,
                    team_name: pred.team_name,
                    grid_position: index + 1  // Use upload order as grid position
                }));
                currentRaceData = data;
                hasActualPositions = false;  // Uploaded CSV doesn't have actual positions
                
                // Display race info from CSV
                document.getElementById('raceName').textContent = 'UPLOADED RACE DATA';
                
                renderDriverGrid();
                showGridPage();
                showMessage(`CSV uploaded: ${currentDrivers.length} drivers`, 'success');
            } catch (error) {
                console.error('Upload exception:', error);
                showMessage('Upload error: ' + error.message, 'error');
            }
        }
        
        window.onload = init;
    </script>
</body>
</html>
